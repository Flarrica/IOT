<script>
  let estadoActual = "stopped";
  let estadoAnterior = "stopped";
  let esperandoCambioDeEstado = false;

  function sendCmd(cmd) {
    fetch("/cmd?cmd=" + cmd, { credentials: 'omit' })
      .then(r => console.log("Comando enviado:", cmd));
  }

  function togglePlayPause() {
    if (esperandoCambioDeEstado) {
      console.log("Esperando cambio de estado... Ignorando click.");
      return;
    }

    if (estadoActual === "playing") {
      sendCmd("pause");
    } else {
      sendCmd("play");
    }

    esperandoCambioDeEstado = true;
  }

  function actualizarEstado() {
    fetch("/status", { credentials: 'omit' })
      .then(r => r.json())
      .then(data => {
        estadoAnterior = estadoActual;
        estadoActual = data.estado || "unknown";

        const div = document.getElementById("estado");
        div.textContent = estadoActual.toUpperCase();
        div.className = "estado " + (
          estadoActual === "playing" ? "verde" :
          estadoActual === "paused"  ? "azul" :
          "rojo"
        );

        if (estadoActual !== estadoAnterior) {
          esperandoCambioDeEstado = false;
        }
      })
      .catch(err => {
        console.error("Error al obtener estado:", err);
      });
  }

  function guardarWiFi(e) {
    e.preventDefault();
    const ssid = document.getElementById("ssid").value;
    const pass = document.getElementById("pass").value;
    const mqtt = document.getElementById("mqtt_url").value;

    const body = `ssid=${encodeURIComponent(ssid)}&pass=${encodeURIComponent(pass)}&mqtt_url=${mqtt}`;
    fetch("/guardar_wifi", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: body,
      credentials: "omit"
    })
    .then(r => r.text())
    .then(html => document.body.innerHTML = html)
    .catch(err => alert("Error al enviar: " + err));
  }

  function reiniciar(e) {
    e.preventDefault();
    fetch("/reset", {
      method: "GET",
      credentials: "omit"
    })
    .then(r => r.text())
    .then(html => document.body.innerHTML = html)
    .catch(err => alert("Error al reiniciar: " + err));
  }

  function cargarWav(e) {
    e.preventDefault();
    const files = document.querySelector('input[type="file"]').files;
    if (files.length === 0) return;

    for (let i = 0; i < files.length; i++) {
      const formData = new FormData();
      formData.append("audio", files[i]);

      fetch("/upload", {
        method: "POST",
        body: formData
      })
      .then(r => r.text()
